on: [push, workflow_dispatch]
name: Build Image with Packer
jobs:
  build:
    name: Build
    runs-on: buildjet-2vcpu-ubuntu-2204-arm
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Packer
        uses: hashicorp-contrib/setup-packer@v2

      - name: Build
        run: |
          sudo chmod +x ./.github/scripts/build-packer.sh
          sudo ./.github/scripts/build-packer.sh
          find . -maxdepth 4 -type f -name "*.img" -exec basename {} \;

      - name: Upload
        uses: actions/upload-artifact@v3
        with:
          name: packer-${{ github.run_id }}
          path: |
            ./*.zip
            !*.img
